<div class="admin-products-layout">
  <div class="mb-3 d-flex gap-3">
    <button (click)="modoFormulario = 'crear'">Crear Producto</button>
    <button (click)="modoFormulario = 'editar'">Editar Producto</button>
  </div>

  <div *ngIf="modoFormulario === 'crear'" class="product-creation-preview">
    <div class="creation-form">
      <h3>Crear nuevo producto</h3>
      <label>Nombre:</label>
      <input [(ngModel)]="newProduct.name" placeholder="Nombre del producto" />
      <label>Descripción:</label>
      <textarea [(ngModel)]="newProduct.description" placeholder="Descripción" rows="3"></textarea>
      <label>Precio:</label>
      <input type="number" [(ngModel)]="newProduct.price" placeholder="Precio (€)" />
      <label>Rating:</label>
      <input type="number" [(ngModel)]="newProduct.rating" step="0.1" min="0" max="5" placeholder="Rating (0.0 - 5.0)" />

      <label>Categoría:</label>
      <select [(ngModel)]="newProduct.categoryId">
        <option value="">Seleccionar categoría</option>
        <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
      </select>

      <label for="imageInput">Imagen del producto:</label>
      <input type="file" id="imageInput" #imageInput (change)="onImageSelected($event)" accept="image/*" class="form-control mb-2" />

      <label>Agregar Ingrediente:</label>
      <div class="row g-2">
        <div class="col-md-9 col-12">
          <select class="form-select" [(ngModel)]="selectedIngredientId">
            <option [ngValue]="''" disabled selected>Selecciona un ingrediente</option>
            <option *ngFor="let ing of availableIngredients()" [value]="ing.id">{{ ing.name }}</option>
          </select>
        </div>
        <div class="col-md-3 col-12">
          <button type="button" class="btn btn-secondary w-100" (click)="addIngredient()">Añadir</button>
        </div>
      </div>

      <label>Agregar Alérgeno:</label>
      <div class="row g-2">
        <div class="col-md-9 col-12">
          <select class="form-select" [(ngModel)]="selectedAllergenId">
            <option [ngValue]="''" disabled selected>Selecciona un alérgeno</option>
            <option *ngFor="let al of availableAllergens()" [value]="al.id">{{ al.name }}</option>
          </select>
        </div>
        <div class="col-md-3 col-12">
          <button type="button" class="btn btn-secondary w-100" (click)="addAllergen()">Añadir</button>
        </div>
      </div>

      <button (click)="crearProducto()">Crear producto</button>
    </div>

    <div class="preview">
      <h4>Previsualización</h4>
      <p><strong>Nombre:</strong> {{ newProduct.name }}</p>
      <p><strong>Descripción:</strong> {{ newProduct.description }}</p>
      <p><strong>Precio:</strong> {{ newProduct.price }} €</p>
      <p><strong>Categoría:</strong> {{ getCategoryName(newProduct.categoryId) }}</p>
      <p><strong>Ingredientes:</strong></p>
      <div class="selected-ingredients mt-2">
        <span *ngFor="let id of newProduct.ingredientIds" class="ingredient-pill">
          {{ getIngredientName(id) }}
          <button type="button" (click)="removeIngredient(id)">✖</button>
        </span>
      </div>
      <p><strong>Alérgenos:</strong></p>
      <div class="selected-ingredients mt-2">
        <span *ngFor="let id of newProductAllergenIds" class="ingredient-pill">
          {{ getAllergenName(id) }}
          <button type="button" (click)="removeAllergen(id)">✖</button>
        </span>
      </div>
      <div *ngIf="productImageBase64">
        <p><strong>Imagen cargada:</strong></p>
        <img [src]="productImageBase64" alt="Previsualización" style="max-width: 150px; border-radius: 8px;" />
      </div>
    </div>
  </div>

  <div *ngIf="modoFormulario === 'editar'" class="product-creation-preview">
    <div class="creation-form">
      <h3>Editar producto</h3>
      <label>Seleccionar producto:</label>
      <select [(ngModel)]="selectedEditProductId" (change)="cargarProductoAEditar()">
        <option value="">Seleccionar producto</option>
        <option *ngFor="let p of products" [ngValue]="p.id">{{ p.name }}</option>
      </select>

      <ng-container *ngIf="editingProduct">
        <label>Nombre:</label>
        <input [(ngModel)]="editingProduct.name" placeholder="Nombre del producto" />
        <label>Descripción:</label>
        <textarea [(ngModel)]="editingProduct.description" placeholder="Descripción" rows="3"></textarea>
        <label>Precio:</label>
        <input type="number" [(ngModel)]="editingProduct.price" placeholder="Precio (€)" />
        <label>Rating:</label>
        <input type="number" [(ngModel)]="editingProduct.rating" step="0.1" min="0" max="5" placeholder="Rating (0.0 - 5.0)" />

        <label>Categoría:</label>
        <select [(ngModel)]="editingProduct.categoryId">
          <option *ngFor="let cat of categories" [ngValue]="cat.id">{{ cat.name }}</option>
        </select>

        <label for="editImageInput">Imagen del producto:</label>
        <input type="file" id="editImageInput" (change)="onImageSelected($event)" accept="image/*" class="form-control mb-2" />

        <label>Agregar Ingrediente:</label>
        <div class="row g-2">
          <div class="col-md-9 col-12">
            <select class="form-select" [(ngModel)]="selectedIngredientId">
              <option [ngValue]="''" disabled selected>Selecciona un ingrediente</option>
              <option *ngFor="let ing of ingredients" [value]="ing.id">{{ ing.name }}</option>
            </select>
          </div>
          <div class="col-md-3 col-12">
            <button type="button" class="btn btn-secondary w-100" (click)="addEditingIngredient()">Añadir</button>
          </div>
        </div>

        <label>Agregar Alérgeno:</label>
        <div class="row g-2">
          <div class="col-md-9 col-12">
            <select class="form-select" [(ngModel)]="selectedAllergenId">
              <option [ngValue]="''" disabled selected>Selecciona un alérgeno</option>
              <option *ngFor="let al of allergens" [value]="al.id">{{ al.name }}</option>
            </select>
          </div>
          <div class="col-md-3 col-12">
            <button type="button" class="btn btn-secondary w-100" (click)="addEditingAllergen()">Añadir</button>
          </div>
        </div>

        <button class="btn btn-primary mt-2" (click)="guardarEdicion()">Guardar cambios</button>
        <button class="btn btn-secondary mt-2 ms-2" (click)="cancelarEdicion()">Cancelar</button>
      </ng-container>
    </div>

    <div class="preview" *ngIf="editingProduct">
      <h4>Previsualización</h4>
      <p><strong>Nombre:</strong> {{ editingProduct.name }}</p>
      <p><strong>Descripción:</strong> {{ editingProduct.description }}</p>
      <p><strong>Precio:</strong> {{ editingProduct.price }} €</p>
      <p><strong>Categoría:</strong> {{ getCategoryName(editingProduct.categoryId) }}</p>
      <p><strong>Ingredientes:</strong></p>
      <div class="selected-ingredients mt-2">
        <span *ngFor="let id of editingProduct.ingredientIds" class="ingredient-pill">
          {{ getIngredientName(id) }}
          <button type="button" (click)="removeEditingIngredient(id)">✖</button>
        </span>
      </div>
      <p><strong>Alérgenos:</strong></p>
      <div class="selected-ingredients mt-2">
        <span *ngFor="let al of editingProduct.allergens" class="ingredient-pill">
          {{ getAllergenName(al.id) }}
          <button type="button" (click)="removeEditingAllergen(al.id)">✖</button>
        </span>
      </div>
      <div *ngIf="editingProduct.image">
        <p><strong>Imagen actual:</strong></p>
        <img [src]="editingProduct.image" alt="Imagen" style="max-width: 150px; border-radius: 8px;" />
      </div>
    </div>
  </div>

  <hr />

  <div class="filter-section">
    <input [(ngModel)]="filterName" placeholder="Filtrar por nombre" />
    <select [(ngModel)]="filterCategoryId">
      <option value="">Todas las categorías</option>
      <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
    </select>
  </div>

  <table class="table table-dark table-bordered mt-4">
    <thead>
    <tr>
      <th>Nombre</th>
      <th>Descripción</th>
      <th>Precio</th>
      <th>Categoría</th>
      <th>Acciones</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let p of getFilteredProducts()">
      <td>{{ p.name }}</td>
      <td>{{ p.description }}</td>
      <td>{{ p.price }} €</td>
      <td>{{ p.foodCategory?.name }}</td>
      <td><button (click)="eliminarProducto(p.id)" class="btn btn-danger btn-sm">Eliminar</button></td>
    </tr>
    </tbody>
  </table>
</div>
